/*
 * L.Control.GeoSearch - search for an address and zoom to its location
 * https://github.com/smeijer/L.GeoSearch
 */
L.GeoSearch={},L.GeoSearch.Provider={},L.GeoSearch.Result=function(e,t,o,s,i){this.X=e,this.Y=t,this.Label=o,this.bounds=s,i&&(this.details=i)},L.Control.GeoSearch=L.Control.extend({options:{position:"topleft",showMarker:!0,showPopup:!1,customIcon:!1,retainZoomLevel:!1,draggable:!1},_config:{country:"",searchLabel:"Enter address",notFoundMessage:"Sorry, that address could not be found.",messageHideDelay:3e3,zoomLevel:18},initialize:function(e){L.Util.extend(this.options,e),L.Util.extend(this._config,e)},resetLink:function(e){var t=this._container.querySelector("a");t.className="leaflet-bar-part leaflet-bar-part-single "+e},onAdd:function(){this._container=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-geosearch");var e=L.DomUtil.create("a","",this._container);e.href="#",e.title=this._config.searchLabel,this.resetLink("glass");var t=L.DomUtil.create("form","displayNone",this._container),o=L.DomUtil.create("input",null,t);o.type="text",o.placeholder=this._config.searchLabel,this._searchbox=o;var s=L.DomUtil.create("div","leaflet-bar message displayNone",this._container);return this._msgbox=s,L.DomEvent.on(e,"click",L.DomEvent.stopPropagation).on(e,"click",L.DomEvent.preventDefault).on(e,"click",function(){L.DomUtil.hasClass(t,"displayNone")?(L.DomUtil.removeClass(t,"displayNone"),o.focus()):L.DomUtil.addClass(t,"displayNone")}).on(e,"dblclick",L.DomEvent.stopPropagation),L.DomEvent.addListener(this._searchbox,"keypress",this._onKeyPress,this).addListener(this._searchbox,"keyup",this._onKeyUp,this).addListener(this._searchbox,"input",this._onInput,this),L.DomEvent.disableClickPropagation(this._container),this._container},geosearch:function(e){var t=this;try{var o=this._config.provider;if("function"==typeof o.GetLocations)o.GetLocations(e,function(o){t._processResults(o,e)});else{var s=o.GetServiceUrl(e);this.sendRequest(o,s,e)}}catch(i){this._printError(i)}},cancelSearch:function(){var e=this._container.querySelector("form");L.DomUtil.addClass(e,"displayNone"),this._searchbox.value="",this.resetLink("glass"),L.DomUtil.addClass(this._msgbox,"displayNone"),this._map._container.focus()},startSearch:function(){this.resetLink("spinner"),this.geosearch(this._searchbox.value)},sendRequest:function(e,t,o){function s(e){e+="&callback=parseLocation";var t=document.createElement("script");t.id="getJsonP",t.src=e,t.async=!0,document.body.appendChild(t)}var i=this;if(window.parseLocation=function(t){var s=e.ParseJSON(t);i._processResults(s,o),document.body.removeChild(document.getElementById("getJsonP")),delete window.parseLocation},XMLHttpRequest){var n=new XMLHttpRequest;if("withCredentials"in n){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==n.readyState)if(200==n.status){var r=JSON.parse(n.responseText),a=e.ParseJSON(r);i._processResults(a,o)}else 0==n.status||400==n.status?s(t):i._printError(n.responseText)},n.open("GET",t,!0),n.send()}else if(XDomainRequest){var r=new XDomainRequest;r.onerror=function(e){i._printError(e)},r.onload=function(){var t=JSON.parse(r.responseText),s=e.ParseJSON(t);i._processResults(s,o)},r.open("GET",t),r.send()}else s(t)}},_processResults:function(e,t){e.length>0?(this._map.fireEvent("geosearch_foundlocations",{Locations:e}),this._showLocation(e[0],t),this.cancelSearch()):this._printError(this._config.notFoundMessage)},_showLocation:function(e,t){1==this.options.showMarker&&(void 0===this._positionMarker?(this._positionMarker=L.marker([e.Y,e.X],{draggable:this.options.draggable}).addTo(this._map),this.options.customIcon&&this._positionMarker.setIcon(this.options.customIcon),this.options.showPopup&&this._positionMarker.bindPopup(t).openPopup()):(this._positionMarker.setLatLng([e.Y,e.X]),this.options.showPopup&&this._positionMarker.bindPopup(t).openPopup())),!this.options.retainZoomLevel&&e.bounds&&e.bounds.isValid()?this._map.fitBounds(e.bounds):this._map.setView([e.Y,e.X],this._getZoomLevel(),!1),this._map.fireEvent("geosearch_showlocation",{Location:e,Marker:this._positionMarker})},_isShowingError:!1,_printError:function(e){this._msgbox.innerHTML=e,L.DomUtil.removeClass(this._msgbox,"displayNone"),this._map.fireEvent("geosearch_error",{message:e}),this.resetLink("alert"),this._isShowingError=!0},_onKeyUp:function(e){var t=27;e.keyCode===t&&this.cancelSearch()},_getZoomLevel:function(){return this.options.retainZoomLevel?this._map._zoom:this._config.zoomLevel},_onInput:function(){this._isShowingError&&(this.resetLink("glass"),L.DomUtil.addClass(this._msgbox,"displayNone"),this._isShowingError=!1)},_onKeyPress:function(e){var t=13;e.keyCode===t&&(e.preventDefault(),e.stopPropagation(),this.startSearch())}});
